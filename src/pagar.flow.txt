import { addKeyword, EVENTS } from "@builderbot/bot";

import { createFlow } from "@builderbot/bot";
import { ExistsEvent, validateGraduate } from "src/services/backend";
import {flowfinish} from "src/Adios";
const flowpagarBoletos = addKeyword(["1", "uno", "UNO", "primera"])
    .addAction({ capture: true }, async (ctx, { state, flowDynamic, endFlow }) => {
        await flowDynamic(`Â¿CuÃ¡ntos boletos quieres comprar? `);
        await flowDynamic(`Escribe el nÃºmero de boletos que deseas adquirir. âœ¨`);
    })
    .addAction({ capture: true }, async (ctx, { state, flowDynamic, fallBack }) => {
        const userInput = ctx.body;
        await state.update({ Number_tickets: parseInt(ctx.body) });
        const amount = state.get('amount'); // Recuperar el amount del state
        const Number_tickets = state.get('Number_tickets');

        if (Number_tickets > 12 || Number_tickets < 1) {
            return fallBack("âŒ Ãšnicamente puedes pagar entre 1 y 12 boletos. Ingresa un nÃºmero de boletos en este rango.");
        }

        // Calcular el total antes de enviar el mensaje
        const totalAmount = Number_tickets * amount;

        // Combinar toda la informaciÃ³n en un solo mensaje mÃ¡s estructurado y claro con emojis
        await flowDynamic(`ğŸ’³ Por favor realiza una transferencia SPEI por la cantidad de ${totalAmount} pesos a la siguiente informaciÃ³n bancaria: 124324132134234.`);

        // AÃ±adir detalles sobre cÃ³mo y dÃ³nde enviar el comprobante, con uso de emojis para destacar acciones
        await flowDynamic(`ğŸ“¸ Una vez realizada la transferencia, por favor envÃ­a una imagen del comprobante para confirmar tu pago. Puedes hacerlo accediendo a este enlace: (https://luxze.mx/comprobantes)`);
    })
    .addAction({ capture: true }, async (ctx, { state, flowDynamic, fallBack }) => {
        
        const userInput = ctx.body;

        const boletos_contrato = state.get('boletos_contrato');
        const boletos_pagados = state.get('boletos_pagados');
        const boletos_restantes = boletos_contrato - boletos_pagados;


        await state.update({ Number_tickets: parseInt(ctx.body) });
        const amount = state.get('amount'); // Recuperar el amount del state
        const Number_tickets = state.get('Number_tickets');

        if (Number_tickets > 12 || Number_tickets < 1 || Number_tickets > boletos_restantes) {
            if (Number_tickets > boletos_restantes) {
                return fallBack("No puedes pagar mÃ¡s de lo que debesğŸ¤”â“");
            } else {
                return fallBack("Escribe el nÃºmero de boletos que deseas adquirir. âœ¨");
            }
        }

        // Calcular el total antes de enviar el mensaje
        const totalAmount = Number_tickets * amount;

        // Combinar toda la informaciÃ³n en un solo mensaje mÃ¡s estructurado y claro con emojis
        await flowDynamic(`ğŸ’³ Por favor realiza una transferencia SPEI por la cantidad de ${totalAmount} pesos a la siguiente informaciÃ³n bancaria: 124324132134234.`);

        // AÃ±adir detalles sobre cÃ³mo y dÃ³nde enviar el comprobante, con uso de emojis para destacar acciones
        await flowDynamic(`ğŸ“¸ Una vez realizada la transferencia, por favor envÃ­a una imagen del comprobante para confirmar tu pago. Puedes hacerlo accediendo a este enlace: (https://luxze.mx/comprobantes)`);
    })
    .addAction({ capture: true }, async (ctx, { state, flowDynamic }) => {
        await flowDynamic("Â¿QuÃ© mÃ¡s te gustarÃ­a hacer? ğŸ˜Š");
        await flowDynamic("3ï¸âƒ£ Confirmo que ya realicÃ© mi pagoğŸ§¾");
        await flowDynamic("4ï¸âƒ£ Hablar con un asesor ğŸ“ğŸ‘¨â€ğŸ’¼");
    })
    .addAction({ capture: true }, async (ctx, { state, flowDynamic, fallBack, endFlow }) => {
        const userInput = ctx.body.toLowerCase();

        if (userInput === '3') {
            localClearHistory(state);
            return endFlow("Perfecto, tu pago serÃ¡ revisado y te confirmamos su realizaciÃ³n ğŸ¤”ğŸ’¬");
        }

        if (userInput === '4') {
            localClearHistory(state);
            return endFlow("Tu nÃºmero de tu empresa por ahora no lo tenemos, pero lo agregaremos en cuanto lo tengamos ğŸ¤”ğŸš€");
        }

        return fallBack("Necesitas escoger alguna opciÃ³n vÃ¡lida como 3ï¸âƒ£ o 4ï¸âƒ£ ğŸ¤”ğŸš€");
    });






const flowConfirm = addKeyword(["1", "uno", "UNO", "primera"])
.addAction(async (_, { flowDynamic }) => {
    await flowDynamic(`Genial. ğŸ‘`);
    await flowDynamic('Por favor, indica la clave de evento que proporcionÃ³ tu Planner.');

})
.addAction({ capture: true }, async (ctx, { state, flowDynamic, fallBack, endFlow }) => {
    localClearHistory(state);
    if (ctx.body.toLowerCase().includes('cancelar')) {
        localClearHistory(state);
        return endFlow("Hemos avisado a un Planner acerca de tu solicitud de soporte. En un momento te contactarÃ¡.");
    }

    if (!state.get('counter')) {
        await state.update({ counter: 0 });
    }

    // Obtain and update the event key in the state
    await state.update({ key: ctx.body });
    const key = state.get('key');
    const counter = state.get('counter');

    const verificate = await ExistsEvent(key);
    console.warn(counter);

    if (verificate.success) {
        localClearHistory(state);
        await flowDynamic(`Tu evento es '${verificate.title}' ğŸ‘¨â€ğŸ“`);
        await flowDynamic("Por favor nos podria proporcionar su nombre o Correo Electronico con el que te registraste en nuestra plataforma Luxze");
        
    } else {
        if (counter < 2) {
            await state.update({ counter: counter + 1 });
            return fallBack(`âŒ No reconozco esta clave. DeberÃ­a ser algo parecida a â€œMKT2025â€ o â€œINGSALLE24â€.`);
        } else {
            localClearHistory(state);
            return endFlow("Hemos avisado a un Planner acerca de tu solicitud de soporte. En un momento te contactarÃ¡.");
        }
    }
})

//flujo de boletos
.addAction({ capture: true }, async (ctx, { state, flowDynamic,fallBack, endFlow }) => {
      
    if (ctx.body.toLowerCase().includes('cancelar')) {
       localClearHistory(state);
       return endFlow("Hemos avisado a un Planner acerca de tu solicitud de soporte. En un momento te contactarÃ¡.");
   }

   if (!state.get('counter')) {
       await state.update({ counter: 0 });
   }

   // Obtain and update the event key in the state
   await state.update({ email_or_name: ctx.body });
   const email_or_name = state.get('email_or_name');
   const counter = state.get('counter');

   const user = await validateGraduate(email_or_name);
   console.warn(counter);

   if (user.success) {
       //localClearHistory(state);
       console.log(user)
       // Assuming 'user' contains both 'graduate' and 'amount' properties.
        const {
        id_graduado,
        nombre_graduado,
        correo_graduado,
        clave_graduado,
        tipo_usuario,
        estado_graduado,
        id_evento_graudado,
        boletos_contrato,
        boletos_pagados,
        mesas_graduado,
        contrato_graduado
        } = user.graduate;

        // Update the state with the graduate data, 'amount', and some other properties.
        await state.update({
        graduate: user.graduate, // Storing the entire graduate object.
        amount: user.amount,     // Including the amount retrieved.
        from: ctx.from,         // Context's 'from' property.
        id_graduado,
        nombre_graduado,
        correo_graduado,
        clave_graduado,
        tipo_usuario,
        estado_graduado,
        id_evento_graudado,
        boletos_contrato,
        boletos_pagados,
        mesas_graduado,
        contrato_graduado
        });


       
       await flowDynamic( ` ${nombre_graduado}, tienes $ ${boletos_contrato} boletos en contrato, de los cuales has pagado: ${boletos_pagados}`);
       await flowDynamic(`El precio por boleto es de $ ${user.amount} . `);
       await flowDynamic( " ");
       await flowDynamic(`Selecciona que quieres hacer: `);
       await flowDynamic( "1ï¸âƒ£ Pagar boletos ğŸ«");
       await flowDynamic( "2ï¸âƒ£ Finalizar conversacion");
      

       if( boletos_pagados === boletos_contrato  ){
           return endFlow("Dado a que has pagado todos los boletos, de mi parte seria todo ğŸ“ğŸ‘¨â€ğŸ’¼");
       }
       
       
       
       
         await flowDynamic(`"(Responde con el numero de la accion que deseasğŸ“ğŸ“§)"`);
       
   } else {
       if (counter < 2) {
           await state.update({ counter: counter + 1 });
           return fallBack("No encuentro este usuario . Prueba con algo como 'atlatian@gmail.com' o 'tunombre@gmail.com'ğŸ¤”â“");
       } else {
           localClearHistory(state);
           return endFlow("Hemos avisado a un Planner acerca de tu solicitud de soporte. En un momento te contactarÃ¡. ğŸ“ğŸ‘¨â€ğŸ’¼");
       }
   }
},
[
    flowpagarBoletos,flowfinish
])









function localClearHistory(state) {
    state.update({ key: null, counter: 0, email: null, personaAVisitar: null, motivo: null, telefono: null });
    }
    
    export { flowConfirm };